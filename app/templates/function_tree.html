<!DOCTYPE html>
<html>
<head>
    <title>Function Segment Tree Viewer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            line-height: 1.6;
            background-color: #f5f5f5;
        }
        header {
            background-color: #333;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            min-height: calc(100vh - 100px);
        }
        .repo-info {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .repo-title {
            font-size: 1.5em;
            font-weight: bold;
        }
        .repo-url {
            color: #666;
            margin-top: 5px;
            word-break: break-all;
        }
        .tree-container {
            display: flex;
        }
        .tree-nav {
            width: 25%;
            border-right: 1px solid #eee;
            padding-right: 20px;
            overflow-y: auto;
            max-height: 800px;
        }
        .function-preview {
            width: 75%;
            padding-left: 20px;
            overflow-y: auto;
            max-height: 800px;
        }
        .node {
            margin-left: 20px;
            position: relative;
        }
        .node-root {
            margin-left: 0;
        }
        .caret {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding: 5px 0;
            display: block;
        }
        .caret::before {
            content: "⊞";
            color: #333;
            display: inline-block;
            margin-right: 6px;
        }
        .caret-down::before {
            content: "⊟";
        }
        .nested {
            display: none;
        }
        .active {
            display: block;
        }
        pre {
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 500px;
        }
        code {
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
            font-size: 14px;
        }
        .breadcrumb {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .breadcrumb a {
            color: #333;
            text-decoration: none;
        }
        .breadcrumb a:hover {
            text-decoration: underline;
        }
        .active-node {
            background-color: #e0f7fa;
            border-radius: 3px;
        }
        .code-type {
            color: #666;
            font-size: 0.8em;
            margin-bottom: 5px;
        }
        .function-name {
            font-weight: bold;
        }
        .file-path {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #09f;
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto;
        }
        .function-details {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        .segment {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 4px;
        }
        .segment-code {
            background-color: #fffde7;
            border: 1px solid #fff59d;
        }
        .segment-call {
            background-color: #e8f5e9;
            border: 1px solid #a5d6a7;
        }
        .segment-comment {
            background-color: #f5f5f5;
            border: 1px solid #e0e0e0;
        }
        .segment-header {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .segment-body {
            padding: 5px;
            background-color: #fff;
            border-radius: 3px;
        }
        .segment-target {
            margin-top: 10px;
            padding: 10px;
            background-color: #f1f8e9;
            border-radius: 3px;
            border-left: 4px solid #7cb342;
        }
        .header-nav a {
            color: white;
            text-decoration: none;
            margin-left: 15px;
        }
        .header-nav a:hover {
            text-decoration: underline;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header>
        <h1>Function Segment Tree Viewer</h1>
        <div class="header-nav">
            <a href="/code/">Home</a>
            <a href="/code/tree/{{ repo_hash }}">AST Tree</a>
        </div>
    </header>
    
    <div class="container">
        <div class="breadcrumb">
            <a href="/code/">Home</a> &gt; 
            <a href="/code/tree/{{ repo_hash }}">{{ repo_name }}</a> &gt;
            <span>Function Tree</span>
        </div>
        
        <div class="repo-info" data-repo-hash="{{ repo_hash }}">
            <div class="repo-title">{{ repo_name }}</div>
            <div class="repo-url">{{ repo_url }}</div>
        </div>
        
        <div class="tree-container">
            <div class="tree-nav" id="tree">
                <div id="loading-tree" class="loading"></div>
            </div>
            <div class="function-preview" id="function-preview">
                <div class="function-preview-content">
                    <p>Select a function from the tree to view its segments.</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const repoHash = document.querySelector('.repo-info').dataset.repoHash;
            loadEntryFunctions(repoHash);
        });

        async function loadEntryFunctions(repoHash) {
            try {
                // Show loading
                const treeElement = document.getElementById('tree');
                treeElement.innerHTML = '<div id="loading-tree" class="loading"></div>';
                
                // Fetch entry functions
                const response = await fetch(`/code/api/functions/${repoHash}/entries`);
                const functions = await response.json();
                
                // Remove loading
                treeElement.innerHTML = '';
                
                if (functions.length === 0) {
                    treeElement.innerHTML = '<p>No entry functions found.</p>';
                    return;
                }
                
                // Build the tree
                const rootElement = document.createElement('div');
                rootElement.className = 'node-root';
                treeElement.appendChild(rootElement);
                
                // Add each entry function
                functions.forEach(func => {
                    const funcNode = document.createElement('div');
                    funcNode.className = 'node';
                    funcNode.dataset.id = func.id;
                    
                    const nameElement = document.createElement('span');
                    nameElement.className = 'caret';
                    nameElement.textContent = func.name;
                    nameElement.onclick = function() {
                        toggleNode(this);
                        loadFunctionDetails(repoHash, func.id);
                    };
                    
                    const childrenElement = document.createElement('div');
                    childrenElement.className = 'nested';
                    
                    funcNode.appendChild(nameElement);
                    funcNode.appendChild(childrenElement);
                    rootElement.appendChild(funcNode);
                });
            } catch (error) {
                console.error('Error loading entry functions:', error);
                document.getElementById('tree').innerHTML = 
                    '<p>Error loading function tree. Please try again later.</p>';
            }
        }

        function toggleNode(element) {
            element.classList.toggle('caret-down');
            const nested = element.parentElement.querySelector('.nested');
            if (nested) {
                nested.classList.toggle('active');
                
                // If there are no children and the node is expanded, load children
                if (nested.children.length === 0 && nested.classList.contains('active')) {
                    const nodeId = element.parentElement.dataset.id;
                    const repoHash = document.querySelector('.repo-info').dataset.repoHash;
                    loadFunctionCallees(repoHash, nodeId, nested);
                }
            }
        }

        async function loadFunctionCallees(repoHash, functionId, parentElement) {
            try {
                // Show loading
                parentElement.innerHTML = '<div class="loading"></div>';
                
                // Fetch callees
                const response = await fetch(`/code/api/functions/${repoHash}/${functionId}/callees`);
                const callees = await response.json();
                
                // Clear loading
                parentElement.innerHTML = '';
                
                if (callees.length === 0) {
                    parentElement.innerHTML = '<div class="node">No function calls</div>';
                    return;
                }
                
                // Add each callee
                callees.forEach(callee => {
                    const calleeNode = document.createElement('div');
                    calleeNode.className = 'node';
                    calleeNode.dataset.id = callee.id;
                    
                    const nameElement = document.createElement('span');
                    nameElement.className = 'caret';
                    nameElement.textContent = callee.name;
                    nameElement.onclick = function() {
                        toggleNode(this);
                        loadFunctionDetails(repoHash, callee.id);
                    };
                    
                    const childrenElement = document.createElement('div');
                    childrenElement.className = 'nested';
                    
                    calleeNode.appendChild(nameElement);
                    calleeNode.appendChild(childrenElement);
                    parentElement.appendChild(calleeNode);
                });
            } catch (error) {
                console.error('Error loading callees:', error);
                parentElement.innerHTML = '<div class="node">Error loading function calls</div>';
            }
        }

        async function loadFunctionDetails(repoHash, functionId) {
            try {
                // Highlight the selected node
                const activeNodes = document.querySelectorAll('.active-node');
                activeNodes.forEach(node => node.classList.remove('active-node'));
                
                const selectedNode = document.querySelector(`[data-id="${functionId}"] > span`);
                if (selectedNode) {
                    selectedNode.classList.add('active-node');
                }
                
                // Show loading
                const previewElement = document.getElementById('function-preview');
                previewElement.innerHTML = '<div class="loading"></div>';
                
                // Fetch function details
                const response = await fetch(`/code/api/functions/${repoHash}/${functionId}`);
                const functionData = await response.json();
                
                // Build the content
                let content = `
                    <div class="function-details">
                        <h2>${functionData.name}</h2>
                        <div class="file-path">${functionData.full_name}</div>
                        <div>File: ${functionData.file_path}</div>
                        <div>Lines: ${functionData.lineno} - ${functionData.end_lineno}</div>
                        ${functionData.is_entry ? '<div><strong>Entry Point</strong></div>' : ''}
                        ${functionData.class_name ? `<div>Class: ${functionData.class_name}</div>` : ''}
                        <div>Module: ${functionData.module_name}</div>
                    </div>
                `;
                
                // Add segments
                if (functionData.segments && functionData.segments.length > 0) {
                    content += '<h3>Segments</h3>';
                    
                    functionData.segments.forEach((segment, index) => {
                        const segmentType = segment.type;
                        const segmentClass = `segment segment-${segmentType}`;
                        
                        content += `
                            <div class="${segmentClass}">
                                <div class="segment-header">
                                    ${segmentType.toUpperCase()} - Line ${segment.lineno}
                                    ${segment.end_lineno ? ` to ${segment.end_lineno}` : ''}
                                </div>
                                <div class="segment-body">
                                    <pre><code>${escapeHTML(segment.content)}</code></pre>
                                </div>
                        `;
                        
                        // For call segments, add target info
                        if (segmentType === 'call' && segment.target_function) {
                            const target = segment.target_function;
                            content += `
                                <div class="segment-target">
                                    <div><strong>Calls:</strong> ${target.name} (${target.full_name})</div>
                                    <div>File: ${target.file_path}</div>
                                    <div>Lines: ${target.lineno} - ${target.end_lineno}</div>
                                    <div>
                                        <a href="#" onclick="loadFunctionDetails('${repoHash}', '${target.id}'); return false;">
                                            View Function
                                        </a>
                                    </div>
                                </div>
                            `;
                        }
                        
                        content += '</div>'; // Close segment div
                    });
                } else {
                    content += '<p>No segments found for this function.</p>';
                }
                
                previewElement.innerHTML = content;
            } catch (error) {
                console.error('Error loading function details:', error);
                document.getElementById('function-preview').innerHTML = 
                    '<p>Error loading function details. Please try again later.</p>';
            }
        }

        // Helper function to escape HTML
        function escapeHTML(str) {
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
    </script>
</body>
</html>